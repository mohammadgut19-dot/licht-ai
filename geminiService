import { GoogleGenAI, Type } from "@google/genai";
import { Listing, UserProfile } from "./types";

// اصلاح نحوه فراخوانی API Key برای محیط وب (Vite)
const API_KEY = import.meta.env.VITE_API_KEY || ""; 
const getAI = () => new GoogleGenAI({ apiKey: API_KEY });

/**
 * تولید ویدیو با مدل Veo - اصلاح شده برای پروژه mofa
 */
export const generateVideo = async (prompt: string, onProgress?: (status: string) => void) => {
  const ai = getAI();
  
  onProgress?.("Initializing Neural Vision Core...");
  
  try {
    let operation = await ai.models.generateVideos({
      model: 'veo-3.1-generate-preview',
      prompt: prompt,
      config: {
        numberOfVideos: 1,
        resolution: '1080p',
        aspectRatio: '16:9'
      }
    });

    onProgress?.("Synthesizing reality frames...");

    while (!operation.done) {
      await new Promise(resolve => setTimeout(resolve, 10000));
      onProgress?.("Rendering high-fidelity temporal sequences...");
      operation = await ai.operations.getVideosOperation({ operation: operation });
    }

    if (operation.error) {
      const errorMessage = operation.error.message || "Video generation failed.";
      console.error(`[mofa Error]: ${errorMessage}`);
      
      if (errorMessage.includes("quota")) {
        throw new Error("سهمیه روزانه mofa تمام شده است.");
      }
      throw new Error(errorMessage);
    }

    const downloadLink = operation.response?.generatedVideos?.[0]?.video?.uri;
    if (!downloadLink) throw new Error("No video URI returned.");

    // اصلاح علامت & به ? برای پارامتر اول URL
    const response = await fetch(`${downloadLink}?key=${API_KEY}`);
    const blob = await response.blob();
    return URL.createObjectURL(blob);

  } catch (error: any) {
    console.error("Video Generation Error:", error);
    throw error;
  }
};

/**
 * چت پیشرفته با قابلیت جستجوی گوگل برای بازار آلمان
 */
export const chatWithGemini = async (
  message: string, 
  history: any[] = [], 
  options: { thinking?: boolean; search?: boolean; imageBase64?: string; mimeType?: string } = {}
) => {
  const ai = getAI();
  const model = "gemini-3-pro-preview";
  const config: any = {};
  
  if (options.thinking) {
    config.thinkingConfig = { thinkingBudget: 32768 };
  }

  if (options.search) {
    config.tools = [{ googleSearch: {} }];
  }

  const parts: any[] = [{ text: message }];
  
  if (options.imageBase64 && options.mimeType) {
    parts.push({
      inlineData: {
        data: options.imageBase64,
        mimeType: options.mimeType
      }
    });
  }

  const systemInstruction = `You are Licht AI, the intelligent core of the mofa ecosystem. 
    You assist users with job searching in Germany, housing, and content creation.`;

  const response = await ai.models.generateContent({
    model,
    contents: [{ role: "user", parts }], // اصلاح ساختار contents
    config: {
      ...config,
      systemInstruction
    }
  });

  return {
    text: response.text || "در حال پردازش...",
    grounding: response.candidates?.[0]?.groundingMetadata?.groundingChunks || []
  };
};
